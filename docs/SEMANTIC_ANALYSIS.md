# Baa Language Semantic Analysis Documentation (New Design)

**Status: This document outlines the planned design for the Semantic Analysis phase. All items are planned unless otherwise noted. This phase will operate on the AST generated by the new Parser.**

## 1. Overview and Goals

The Semantic Analysis phase is a critical part of the Baa compiler that bridges parsing and code generation. Its primary goals are:

*   **Verify Static Semantics:** Ensure the program adheres to all language rules that are not purely syntactic (e.g., type rules, scope rules).
*   **Name Resolution:** Resolve all identifiers to their declarations.
*   **Type Checking:** Verify type correctness for all expressions, statements, and declarations.
*   **AST Annotation:** Enrich the Abstract Syntax Tree (AST) with semantic information (e.g., resolved types, links to symbol table entries) needed for later phases like code generation.
*   **Error Reporting:** Detect and report semantic errors clearly, with accurate source location information.

**Input:** Abstract Syntax Tree (AST) from the Parser (`docs/AST.md`).
**Output:** An annotated and validated AST, and a list of semantic errors/warnings.

## 2. Core Components and Sub-Phases

### 2.1 Symbol Table Management
    - [ ] Design and implement symbol table structures (e.g., hash tables or balanced trees for scopes).
    - [ ] Implement scope handling:
        - [ ] Global scope.
        - [ ] Function scope.
        - [ ] Block scope.
        - [ ] Rules for scope entry and exit.
    - [ ] Define symbol entries (for variables, functions, types, etc.) storing attributes like type, kind, definition location, modifiers.

### 2.2 Name Resolution
    - [ ] Implement algorithms to resolve identifiers to their declared symbols within the correct scope.
    - [ ] Handle identifier shadowing rules.
    - [ ] Report errors for undeclared identifiers or ambiguous references.

### 2.3 Type Checking
    - [ ] Implement type inference/checking for expressions:
        - [ ] Literals.
        - [ ] Variable references (using resolved symbol type).
        - [ ] Unary and binary operations (using operator validation rules from `src/operators/` and type compatibility rules from `src/types/`).
        - [ ] Function calls (checking argument types against parameter types, and return type).
        - [ ] Assignment expressions.
        - [ ] Array indexing and other planned expressions.
    - [ ] Implement type checking for statements:
        - [ ] Variable declarations (initializer compatibility).
        - [ ] If statement conditions (must be boolean or convertible).
        - [ ] While/For loop conditions.
        - [ ] Return statement values (compatibility with function return type).
    - [ ] Define and implement type compatibility and conversion rules (implicit and explicit casts).

### 2.4 Control Flow Analysis
    - [ ] Integrate and adapt existing `src/analysis/flow_analysis.c` to work with the new AST.
    - [ ] Verify that all paths in non-void functions return a value.
    - [ ] Check for unreachable code.
    - [ ] Validate correct usage of `توقف` (break) and `أكمل` (continue).

### 2.5 Other Semantic Checks
    - [ ] Enforce `ثابت` (const) correctness (e.g., no assignment to const variables after initialization).
    - [ ] Validate usage of `مقيد` (restrict) qualifiers on pointers.
    - [ ] Validate usage of `مضمن` (inline) function specifiers (if any semantic rules apply beyond hints).
    - [ ] Check for main function (`رئيسية`) correctness.

## 3. AST Annotation

- [ ] Plan how the AST will be annotated:
    - [ ] Expression nodes: Store resolved type.
    - [ ] Variable/Function call nodes: Link to symbol table entry for the declaration.
    - [ ] Other relevant annotations.

## 4. Error Reporting

- [ ] Design a system for collecting and reporting semantic errors.
- [ ] Ensure error messages are clear, in Arabic, and provide precise source location information (line, column).
- [ ] Consider different severity levels (e.g., errors, warnings).

## 5. Interaction with Other Phases

- **Parser:** Consumes the AST generated by the parser.
- **Code Generator:** The annotated AST produced by semantic analysis will be the input for the code generation phase.

## Arabic/RTL Considerations

- Error messages must be clear and correctly formatted for RTL display, referencing source code accurately.
- Symbol table lookups and storage must correctly handle Arabic identifiers.
