// ============================================================================
// اختبار ضغط السجلات عبر الحلقات (Register Allocator Stress - Loop Liveness)
// ============================================================================
// الهدف:
// - كشف مشاكل الحيوية عبر حواف الرجوع (back-edges) داخل الحلقات تحت ضغط سجلات عالٍ.
// - تضمين نداء دالة داخل الحلقة لضمان التعامل الصحيح مع caller-saved.
//
// التشغيل:
//   build\baa.exe tests\backend_regalloc_stress.baa -o build\backend_regalloc_stress.exe -v
//   build\backend_regalloc_stress.exe
//   echo %ERRORLEVEL%  (يجب أن يكون 0)
// ============================================================================

صحيح عد = 0.

صحيح تحقق(صحيح فعلي, صحيح متوقع) {
    عد = عد + 1.
    إذا (فعلي != متوقع) {
        اطبع "فشل تحقق:".
        اطبع عد.
        اطبع "فعلي:".
        اطبع فعلي.
        اطبع "متوقع:".
        اطبع متوقع.
        إرجع 1.
    }
    إرجع 0.
}

// دالة صغيرة لاختبار CALL داخل الحلقة
صحيح مساعدة(صحيح س) {
    إرجع س * 3 + 1.
}

صحيح اختبار_ضغط_حلقة() {
    صحيح خ = 0.
    ثابت صحيح ن = 2000.

    // 12 متغيراً حلقيّاً (ضغط عالٍ)
    صحيح أ = 1.
    صحيح ب = 2.
    صحيح ج = 3.
    صحيح د = 4.
    صحيح هـ = 5.
    صحيح و = 6.
    صحيح ز = 7.
    صحيح ح = 8.
    صحيح ط = 9.
    صحيح ي = 10.
    صحيح ك = 11.
    صحيح ل = 12.

    صحيح م = 0.
    صحيح ت = 0.

    طالما (ت < ن) {
        // قبل النداء (تجعل القيم حية قبل CALL)
        أ = أ + 1.
        ب = ب + 2.
        ج = ج + 3.
        د = د + 4.

        // نداء داخل الحلقة: يجب ألا تُخرب القيم الحية عبره
        م = مساعدة(أ).
        م = م + 1.
        إذا (م == -1) {
            اطبع "مستحيل".
        }

        // بعد النداء (يضمن أن بقية المتغيرات كانت حية عبر CALL)
        هـ = هـ + 5.
        و = و + 6.
        ز = ز + 7.
        ح = ح + 8.
        ط = ط + 9.
        ي = ي + 10.
        ك = ك + 11.
        ل = ل + 12.

        ت = ت + 1.
    }

    // التحقق من النتائج
    خ = خ + تحقق(أ, 1 + ن).
    خ = خ + تحقق(ب, 2 + 2 * ن).
    خ = خ + تحقق(ج, 3 + 3 * ن).
    خ = خ + تحقق(د, 4 + 4 * ن).
    خ = خ + تحقق(هـ, 5 + 5 * ن).
    خ = خ + تحقق(و, 6 + 6 * ن).
    خ = خ + تحقق(ز, 7 + 7 * ن).
    خ = خ + تحقق(ح, 8 + 8 * ن).
    خ = خ + تحقق(ط, 9 + 9 * ن).
    خ = خ + تحقق(ي, 10 + 10 * ن).
    خ = خ + تحقق(ك, 11 + 11 * ن).
    خ = خ + تحقق(ل, 12 + 12 * ن).

    // م في آخر دورة: (3*(1+n) + 1) + 1 = 3n + 5
    خ = خ + تحقق(م, 3 * ن + 5).
    إرجع خ.
}

صحيح اختبار_ضغط_حلقة_متداخلة() {
    صحيح خ = 0.
    ثابت صحيح خارجي = 200.
    ثابت صحيح داخلي = 50.
    ثابت صحيح ن = خارجي * داخلي.

    صحيح أ = 10.
    صحيح ب = 20.
    صحيح ج = 30.
    صحيح د = 40.
    صحيح هـ = 50.
    صحيح و = 60.
    صحيح ز = 70.
    صحيح ح = 80.
    صحيح ط = 90.
    صحيح ي = 100.
    صحيح ك = 110.
    صحيح ل = 120.

    صحيح م = 0.
    صحيح س = 0.

    لكل (صحيح ع = 0؛ ع < خارجي؛ ع = ع + 1) {
        لكل (صحيح ص = 0؛ ص < داخلي؛ ص = ص + 1) {
            أ = أ + 1.
            ب = ب + 2.
            ج = ج + 3.
            د = د + 4.

            م = مساعدة(ب).

            هـ = هـ + 5.
            و = و + 6.
            ز = ز + 7.
            ح = ح + 8.
            ط = ط + 9.
            ي = ي + 10.
            ك = ك + 11.
            ل = ل + 12.

            س = س + 1.
        }
    }

    خ = خ + تحقق(س, ن).
    خ = خ + تحقق(أ, 10 + 1 * ن).
    خ = خ + تحقق(ب, 20 + 2 * ن).
    خ = خ + تحقق(ج, 30 + 3 * ن).
    خ = خ + تحقق(د, 40 + 4 * ن).
    خ = خ + تحقق(هـ, 50 + 5 * ن).
    خ = خ + تحقق(و, 60 + 6 * ن).
    خ = خ + تحقق(ز, 70 + 7 * ن).
    خ = خ + تحقق(ح, 80 + 8 * ن).
    خ = خ + تحقق(ط, 90 + 9 * ن).
    خ = خ + تحقق(ي, 100 + 10 * ن).
    خ = خ + تحقق(ك, 110 + 11 * ن).
    خ = خ + تحقق(ل, 120 + 12 * ن).

    // م هنا يعتمد على آخر قيمة ب: ب_final = 20 + 2*n
    // م = 3*b_final + 1
    خ = خ + تحقق(م, 3 * (20 + 2 * ن) + 1).
    إرجع خ.
}

صحيح الرئيسية() {
    صحيح إجمالي = 0.

    اطبع "=== اختبار ضغط السجلات (الحيوية عبر الحلقات) ===".
    إجمالي = إجمالي + اختبار_ضغط_حلقة().
    إجمالي = إجمالي + اختبار_ضغط_حلقة_متداخلة().

    اطبع "=== النتائج ===".
    اطبع "عدد الاختبارات:".
    اطبع عد.
    اطبع "عدد الأخطاء:".
    اطبع إجمالي.

    إذا (إجمالي == 0) {
        اطبع "PASS".
    } وإلا {
        اطبع "FAIL".
    }

    إرجع إجمالي.
}
