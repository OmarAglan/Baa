// ============================================================================
// اختبار نطاقات الكتل (Block-Level Scoping) - v0.3.2.6.4
// ============================================================================
// الهدف:
// - السماح بإعادة تعريف متغيرات داخل كتل مختلفة في نفس الدالة.
// - جعل متغيرات for-init ضمن نطاق الحلقة فقط.
// - التأكد من أن الظلّ (shadowing) يعمل بشكل صحيح (الأقرب يغلب).
//
// التشغيل:
//   build\baa.exe tests\backend_scope_test.baa -o build\backend_scope_test.exe -v
//   build\backend_scope_test.exe
//   echo %ERRORLEVEL%  (يجب أن يكون 0)
// ============================================================================

صحيح عد = 0.

صحيح تحقق(صحيح فعلي, صحيح متوقع) {
    عد = عد + 1.
    إذا (فعلي != متوقع) {
        اطبع "فشل تحقق:".
        اطبع عد.
        إرجع 1.
    }
    إرجع 0.
}

صحيح اختبار_كتل_مستقلة() {
    صحيح خ = 0.

    {
        صحيح س = 5.
        خ = خ + تحقق(س, 5).
    }

    {
        صحيح س = 7.
        خ = خ + تحقق(س, 7).
    }

    إرجع خ.
}

صحيح اختبار_ظل_محلي() {
    صحيح خ = 0.
    صحيح س = 10.

    {
        صحيح س = 20.
        خ = خ + تحقق(س, 20).
    }

    خ = خ + تحقق(س, 10).
    إرجع خ.
}

صحيح اختبار_تكرار_متغير_لكل() {
    صحيح خ = 0.
    صحيح مجموع = 0.

    لكل (صحيح ع = 0؛ ع < 3؛ ع = ع + 1) {
        مجموع = مجموع + ع.
    }

    // نفس الاسم مرة ثانية في نفس الدالة: يجب أن يُسمح به الآن
    لكل (صحيح ع = 0؛ ع < 4؛ ع = ع + 1) {
        مجموع = مجموع + (ع * 2).
    }

    // 0+1+2 = 3
    // (0*2)+(1*2)+(2*2)+(3*2) = 12
    خ = خ + تحقق(مجموع, 15).
    إرجع خ.
}

صحيح اختبار_تكرار_داخلي_متداخل() {
    صحيح خ = 0.
    صحيح مجموع = 0.

    لكل (صحيح ع = 0؛ ع < 2؛ ع = ع + 1) {
        مجموع = مجموع + 100.

        // ع داخلية (تظلل الخارجية) داخل نطاق مختلف
        لكل (صحيح ع = 0؛ ع < 3؛ ع = ع + 1) {
            مجموع = مجموع + ع.
        }

        مجموع = مجموع + 1.
    }

    // لكل دورة خارجية: +100 + (0+1+2) + 1 = 104
    // دورتان: 208
    خ = خ + تحقق(مجموع, 208).
    إرجع خ.
}

صحيح الرئيسية() {
    صحيح إجمالي = 0.

    اطبع "=== اختبار النطاقات ===".
    إجمالي = إجمالي + اختبار_كتل_مستقلة().
    إجمالي = إجمالي + اختبار_ظل_محلي().
    إجمالي = إجمالي + اختبار_تكرار_متغير_لكل().
    إجمالي = إجمالي + اختبار_تكرار_داخلي_متداخل().

    اطبع "=== النتائج ===".
    اطبع "عدد الاختبارات:".
    اطبع عد.
    اطبع "عدد الأخطاء:".
    اطبع إجمالي.

    إذا (إجمالي == 0) {
        اطبع "PASS".
    } وإلا {
        اطبع "FAIL".
    }

    إرجع إجمالي.
}
