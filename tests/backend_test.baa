// ============================================================================
// اختبار شامل للخلفية الجديدة (IR-based Backend Comprehensive Test)
// ============================================================================
//
// هذا الملف يختبر جميع ميزات لغة باء المدعومة في الخلفية المبنية على IR.
// كل دالة اختبار بسيطة (قليلة المتغيرات) لتجنب ضغط السجلات.
// الدالة الرئيسية تجمع الأخطاء وتُرجع العدد الكلّي (٠ = نجاح).
//
// التشغيل:
//   build\baa.exe tests\backend_test.baa -o build\backend_test.exe -v
//   build\backend_test.exe
//   echo %ERRORLEVEL%     (يجب أن يكون 0)
// ============================================================================

// ────────────────────────────────────────────────────────────────────────────
// المتغيرات العامة (Global Variables)
// ────────────────────────────────────────────────────────────────────────────
صحيح عد = ٠.
صحيح متغير_عام = ٠.

// ثوابت عامة
ثابت صحيح الحد = ١٠.
ثابت صحيح المعامل = ٣.

// ────────────────────────────────────────────────────────────────────────────
// دالة مساعدة: تحقق (Helper: Assert)
// ────────────────────────────────────────────────────────────────────────────
صحيح تحقق(صحيح فعلي, صحيح متوقع) {
    عد = عد + ١.
    إذا (فعلي != متوقع) {
        اطبع "فشل تحقق:".
        اطبع عد.
        إرجع ١.
    }
    إرجع ٠.
}

// ════════════════════════════════════════════════════════════════════════════
// ١. الجمع والطرح (Addition & Subtraction)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_جمع_طرح() {
    صحيح خ = ٠.
    خ = خ + تحقق(٣٠ + ١٢, ٤٢).
    خ = خ + تحقق(٣٠ - ١٢, ١٨).
    خ = خ + تحقق(٠ + ٠, ٠).
    خ = خ + تحقق(١٠٠ - ١٠٠, ٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢. الضرب (Multiplication)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_ضرب() {
    صحيح خ = ٠.
    خ = خ + تحقق(٣٠ * ١٢, ٣٦٠).
    خ = خ + تحقق(٠ * ٩٩٩, ٠).
    خ = خ + تحقق(٧ * ١, ٧).
    خ = خ + تحقق(٢ + ٣ * ٤, ١٤).
    خ = خ + تحقق((٢ + ٣) * ٤, ٢٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٣. القسمة (Division)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_قسمة() {
    صحيح خ = ٠.
    خ = خ + تحقق(٣٠ / ١٢, ٢).
    خ = خ + تحقق(١٠٠ / ١٠, ١٠).
    خ = خ + تحقق(٧ / ١, ٧).
    خ = خ + تحقق(٣ / ١٠, ٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٤. السالب الأحادي (Unary Negation)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_سالب() {
    صحيح خ = ٠.
    صحيح ج = -٥.
    خ = خ + تحقق(ج, -٥).
    خ = خ + تحقق(-ج, ٥).
    خ = خ + تحقق(-٠, ٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٥. المقارنات (Comparisons)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_مقارنات() {
    صحيح خ = ٠.
    صحيح أ = ١٠.
    صحيح ب = ٢٠.

    // يساوي
    صحيح ن١ = ٠.
    إذا (أ == ١٠) { ن١ = ١. }
    خ = خ + تحقق(ن١, ١).

    // لا يساوي
    صحيح ن٢ = ٠.
    إذا (أ != ب) { ن٢ = ١. }
    خ = خ + تحقق(ن٢, ١).

    // أكبر
    صحيح ن٣ = ٠.
    إذا (ب > أ) { ن٣ = ١. }
    خ = خ + تحقق(ن٣, ١).

    // أصغر
    صحيح ن٤ = ٠.
    إذا (أ < ب) { ن٤ = ١. }
    خ = خ + تحقق(ن٤, ١).

    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٦. مقارنات أكبر/أصغر أو يساوي (GE/LE)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_مقارنات٢() {
    صحيح خ = ٠.

    صحيح ن١ = ٠.
    إذا (١٠ <= ١٠) { ن١ = ١. }
    خ = خ + تحقق(ن١, ١).

    صحيح ن٢ = ٠.
    إذا (١٠ >= ١٠) { ن٢ = ١. }
    خ = خ + تحقق(ن٢, ١).

    صحيح ن٣ = ٠.
    إذا (٥ <= ٣) { ن٣ = ١. }
    خ = خ + تحقق(ن٣, ٠).

    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٧. المتغيرات المحلية (Local Variables)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_متغيرات() {
    صحيح خ = ٠.
    صحيح أ = ١٠.
    أ = أ + ٥.
    خ = خ + تحقق(أ, ١٥).
    أ = أ * ٢.
    خ = خ + تحقق(أ, ٣٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٨. الثوابت العامة (Global Constants)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_ثوابت() {
    صحيح خ = ٠.
    خ = خ + تحقق(الحد, ١٠).
    خ = خ + تحقق(المعامل, ٣).
    خ = خ + تحقق(الحد * المعامل, ٣٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٩. إذا بسيط (Simple If)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_إذا() {
    صحيح خ = ٠.
    صحيح ن = ٠.
    إذا (١ == ١) {
        ن = ٤٢.
    }
    خ = خ + تحقق(ن, ٤٢).

    صحيح م = ١٠.
    إذا (م > ٥) {
        م = ٢٠.
    } وإلا {
        م = ٣٠.
    }
    خ = خ + تحقق(م, ٢٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٠. إذا / وإلا إذا / وإلا (If/ElseIf/Else)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_إذا_متعدد() {
    صحيح خ = ٠.
    صحيح ق = ٨٥.
    صحيح نتيجة = ٠.
    إذا (ق >= ٩٠) {
        نتيجة = ١.
    } وإلا إذا (ق >= ٨٠) {
        نتيجة = ٢.
    } وإلا إذا (ق >= ٧٠) {
        نتيجة = ٣.
    } وإلا {
        نتيجة = ٤.
    }
    خ = خ + تحقق(نتيجة, ٢).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١١. حلقة طالما بسيطة (Simple While Loop)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_طالما_بسيط() {
    صحيح خ = ٠.
    صحيح مجموع = ٠.
    صحيح ع = ١.
    طالما (ع <= ١٠) {
        مجموع = مجموع + ع.
        ع = ع + ١.
    }
    خ = خ + تحقق(مجموع, ٥٥).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٢. حلقة طالما مع توقف (While + Break)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_طالما_توقف() {
    صحيح خ = ٠.
    صحيح ف = ٠.
    طالما (ف < ١٠٠) {
        إذا (ف == ٧) {
            توقف.
        }
        ف = ف + ١.
    }
    خ = خ + تحقق(ف, ٧).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٣. حلقة لكل بسيطة (Simple For Loop)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_لكل_بسيط() {
    صحيح خ = ٠.
    صحيح مجموع = ٠.
    لكل (صحيح ع = ٠؛ ع < ٥؛ ع = ع + ١) {
        مجموع = مجموع + ع.
    }
    خ = خ + تحقق(مجموع, ١٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٤. حلقة لكل مع توقف (For + Break)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_لكل_توقف() {
    صحيح خ = ٠.
    صحيح آخر = ٠.
    لكل (صحيح ع = ٠؛ ع < ١٠٠؛ ع = ع + ١) {
        إذا (ع == ٥) {
            توقف.
        }
        آخر = ع.
    }
    خ = خ + تحقق(آخر, ٤).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٥. اختر / حالة (Switch/Case)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_اختر() {
    صحيح خ = ٠.
    صحيح نتيجة = ٠.
    صحيح ق = ٢.
    اختر (ق) {
        حالة ١:
            نتيجة = ١٠.
            توقف.
        حالة ٢:
            نتيجة = ٢٠.
            توقف.
        حالة ٣:
            نتيجة = ٣٠.
            توقف.
        افتراضي:
            نتيجة = -١.
            توقف.
    }
    خ = خ + تحقق(نتيجة, ٢٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٦. اختر مع الحالة الافتراضية (Switch Default)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_اختر_افتراضي() {
    صحيح خ = ٠.
    صحيح نتيجة = ٠.
    صحيح ق = ٩٩.
    اختر (ق) {
        حالة ١:
            نتيجة = ١٠.
            توقف.
        افتراضي:
            نتيجة = -١.
            توقف.
    }
    خ = خ + تحقق(نتيجة, -١).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٧. دالة بدون معاملات (0-arg Function)
// ════════════════════════════════════════════════════════════════════════════
صحيح ثابت_خمسة() {
    إرجع ٥.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٨. دالة بمعامل واحد (1-arg Function)
// ════════════════════════════════════════════════════════════════════════════
صحيح مربع(صحيح ن) {
    إرجع ن * ن.
}

// ════════════════════════════════════════════════════════════════════════════
// ١٩. دالة بمعاملين (2-arg Function)
// ════════════════════════════════════════════════════════════════════════════
صحيح جمع(صحيح أ, صحيح ب) {
    إرجع أ + ب.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٠. دالة بثلاث معاملات (3-arg Function)
// ════════════════════════════════════════════════════════════════════════════
صحيح مجموع_ثلاث(صحيح أ, صحيح ب, صحيح ج) {
    إرجع أ + ب + ج.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢١. دالة بأربع معاملات (4-arg Function)
// ════════════════════════════════════════════════════════════════════════════
صحيح مجموع_أربع(صحيح أ, صحيح ب, صحيح ج, صحيح د) {
    إرجع أ + ب + ج + د.
}

صحيح اختبار_دوال() {
    صحيح خ = ٠.
    خ = خ + تحقق(ثابت_خمسة(), ٥).
    خ = خ + تحقق(مربع(٧), ٤٩).
    خ = خ + تحقق(جمع(٣, ٤), ٧).
    خ = خ + تحقق(مجموع_ثلاث(١, ٢, ٣), ٦).
    خ = خ + تحقق(مجموع_أربع(١, ٢, ٣, ٤), ١٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٢. التكرار: المضروب (Factorial - Recursion)
// ════════════════════════════════════════════════════════════════════════════
صحيح مضروب(صحيح ن) {
    إذا (ن <= ١) {
        إرجع ١.
    }
    إرجع ن * مضروب(ن - ١).
}

صحيح اختبار_مضروب() {
    صحيح خ = ٠.
    خ = خ + تحقق(مضروب(٠), ١).
    خ = خ + تحقق(مضروب(١), ١).
    خ = خ + تحقق(مضروب(٥), ١٢٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٣. التكرار: فيبوناتشي (Fibonacci - Recursion)
// ════════════════════════════════════════════════════════════════════════════
صحيح فيبوناتشي(صحيح ن) {
    إذا (ن <= ٠) {
        إرجع ٠.
    }
    إذا (ن == ١) {
        إرجع ١.
    }
    إرجع فيبوناتشي(ن - ١) + فيبوناتشي(ن - ٢).
}

صحيح اختبار_فيبوناتشي() {
    صحيح خ = ٠.
    خ = خ + تحقق(فيبوناتشي(٠), ٠).
    خ = خ + تحقق(فيبوناتشي(١), ١).
    خ = خ + تحقق(فيبوناتشي(٧), ١٣).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٤. استدعاء متداخل (Nested Function Calls)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_استدعاء_متداخل() {
    صحيح خ = ٠.
    خ = خ + تحقق(جمع(مربع(٣), مربع(٤)), ٢٥).
    خ = خ + تحقق(مربع(جمع(٢, ٣)), ٢٥).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٥. العمليات المنطقية: و (Logical AND)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_و() {
    صحيح خ = ٠.
    صحيح نتيجة = ٠.

    // true AND true
    إذا (١ == ١ && ٢ == ٢) {
        نتيجة = ١.
    } وإلا {
        نتيجة = ٠.
    }
    خ = خ + تحقق(نتيجة, ١).

    // true AND false
    إذا (١ == ١ && ٢ == ٣) {
        نتيجة = ١.
    } وإلا {
        نتيجة = ٠.
    }
    خ = خ + تحقق(نتيجة, ٠).

    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٦. العمليات المنطقية: أو (Logical OR)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_أو() {
    صحيح خ = ٠.
    صحيح نتيجة = ٠.

    // false OR true
    إذا (١ == ٢ || ٣ == ٣) {
        نتيجة = ١.
    } وإلا {
        نتيجة = ٠.
    }
    خ = خ + تحقق(نتيجة, ١).

    // false OR false
    إذا (١ == ٢ || ٣ == ٤) {
        نتيجة = ١.
    } وإلا {
        نتيجة = ٠.
    }
    خ = خ + تحقق(نتيجة, ٠).

    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٧. مقارنة مركبة مع و (Compound Comparison with AND)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_مقارنة_مركبة() {
    صحيح خ = ٠.
    صحيح س = ٥.
    صحيح نتيجة = ٠.
    إذا (س > ٠ && س < ١٠) {
        نتيجة = ١.
    } وإلا {
        نتيجة = ٠.
    }
    خ = خ + تحقق(نتيجة, ١).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٨. الطباعة (Print - no-fail, just ensure no crash)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_طباعة() {
    اطبع ٤٢.
    اطبع "مرحبا".
    صحيح ق = ١٢٣.
    اطبع ق.
    إرجع ٠.
}

// ════════════════════════════════════════════════════════════════════════════
// ٢٩. شرط متعدد المستويات (Multi-level Conditions)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_متعدد() {
    صحيح خ = ٠.
    صحيح ق = ٥٠.
    صحيح فئة = ٠.
    إذا (ق >= ٩٠) {
        فئة = ١.
    } وإلا إذا (ق >= ٧٠) {
        فئة = ٢.
    } وإلا إذا (ق >= ٥٠) {
        فئة = ٣.
    } وإلا {
        فئة = ٤.
    }
    خ = خ + تحقق(فئة, ٣).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٣٠. حالات حدودية (Edge Cases)
// ════════════════════════════════════════════════════════════════════════════
صحيح اختبار_حدود() {
    صحيح خ = ٠.
    خ = خ + تحقق(٠, ٠).
    خ = خ + تحقق(-١ + ١, ٠).
    خ = خ + تحقق(٣ / ١٠, ٠).
    إرجع خ.
}

// ════════════════════════════════════════════════════════════════════════════
// ٣١. المتغيرات العامة: القراءة والكتابة (Global Variable Read/Write)
// ════════════════════════════════════════════════════════════════════════════
صحيح زد_المتغير(صحيح قيمة) {
    متغير_عام = متغير_عام + قيمة.
    إرجع متغير_عام.
}

صحيح اختبار_عامة() {
    صحيح خ = ٠.
    خ = خ + تحقق(متغير_عام, ٠).
    زد_المتغير(١٠).
    خ = خ + تحقق(متغير_عام, ١٠).
    زد_المتغير(٥).
    خ = خ + تحقق(متغير_عام, ١٥).
    متغير_عام = ١٠٠.
    خ = خ + تحقق(متغير_عام, ١٠٠).
    إرجع خ.
}

// ============================================================================
// الدالة الرئيسية (Main)
// ============================================================================

صحيح الرئيسية() {
    صحيح إجمالي = ٠.

    اطبع "=== اختبار الخلفية الشامل ===".

    إجمالي = إجمالي + اختبار_جمع_طرح().
    إجمالي = إجمالي + اختبار_ضرب().
    إجمالي = إجمالي + اختبار_قسمة().
    إجمالي = إجمالي + اختبار_سالب().
    إجمالي = إجمالي + اختبار_مقارنات().
    إجمالي = إجمالي + اختبار_مقارنات٢().
    إجمالي = إجمالي + اختبار_متغيرات().
    إجمالي = إجمالي + اختبار_ثوابت().
    إجمالي = إجمالي + اختبار_إذا().
    إجمالي = إجمالي + اختبار_إذا_متعدد().
    إجمالي = إجمالي + اختبار_طالما_بسيط().
    إجمالي = إجمالي + اختبار_طالما_توقف().
    إجمالي = إجمالي + اختبار_لكل_بسيط().
    إجمالي = إجمالي + اختبار_لكل_توقف().
    إجمالي = إجمالي + اختبار_اختر().
    إجمالي = إجمالي + اختبار_اختر_افتراضي().
    إجمالي = إجمالي + اختبار_دوال().
    إجمالي = إجمالي + اختبار_مضروب().
    إجمالي = إجمالي + اختبار_فيبوناتشي().
    إجمالي = إجمالي + اختبار_استدعاء_متداخل().
    إجمالي = إجمالي + اختبار_و().
    إجمالي = إجمالي + اختبار_أو().
    إجمالي = إجمالي + اختبار_مقارنة_مركبة().
    إجمالي = إجمالي + اختبار_طباعة().
    إجمالي = إجمالي + اختبار_متعدد().
    إجمالي = إجمالي + اختبار_حدود().
    إجمالي = إجمالي + اختبار_عامة().

    // ─── الملخص ───
    اطبع "=== النتائج ===".
    اطبع "عدد الاختبارات:".
    اطبع عد.
    اطبع "عدد الأخطاء:".
    اطبع إجمالي.

    إذا (إجمالي == ٠) {
        اطبع "PASS".
    } وإلا {
        اطبع "FAIL".
    }

    إرجع إجمالي.
}
